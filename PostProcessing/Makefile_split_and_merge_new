# File : Makefile_split_and_merge
#
# This Makefile helps automate the process of : 
# 1: Creating separate directories for each frequency
# 2. Creating split frequency files
# 3: creating global merged logs
# 4: Copy merged log to "run" directory to combine with TEST BM merged log

create_all_folders: create_rodinia_folders create_nvidia_folders create_post_run_dirs

clean_all_dirs: clean_rodinia_dirs clean_nvidia_dirs clean_run_dirs

create_rodinia_folders:	dir_rodinia

create_nvidia_folders:	dir_nvidia 

create_post_run_dirs:	create_run_dir 

# Commands to remove previously created directories
clean_rodinia_dirs: clean_run_rodinia 
clean_nvidia_dirs: clean_run_nvidia
clean_run_dirs: clean_run_dir 

# Commands to create directory
create_all_dir: dir_rodinia dir_nvidia create_run_dir

# Commands to clean directory
clean_all_dir: clean_run_rodinia clean_run_nvidia clean_run_dir

# Define variable to hold global merger python script
MERGER_SCRIPT := global_merger_nvidia.py

# Define variable to hold path of global merger python script
MERGER_SCRIPT_PATH := $(shell readlink -f $(MERGER_SCRIPT))

# Define Filenames for each .dat file
FILE_R0 := power_a57_rodinia.dat

# Define variables to hold path for all .dat files
FILEPATH_R0 := $(shell readlink -f $(FILE_R0))

# Create directory to split and merge data files
dir_rodinia:
	mkdir run_rodinia;\
	cd run_rodinia;\
	cp -r $(FILEPATH_R0) .;\
	cd ..;\
	# Splitting .dat into individual BM+freq logs
	python3 splitter_freq.py $(FILE_R0) run_rodinia;\
	# Merging all BM+freq into one global merged log
	python3 $(MERGER_SCRIPT) run_rodinia rodinia;\
	# Copy file onto a separate folder to combine with TEST BM merged log
	cp -r run_rodinia/power_measurement_merged_global.txt power_measurement_merged_global_r0.txt

# Command to delete directory created during previous run
clean_run_rodinia:
	rm -rf run_rodinia

# Define Filenames for each .dat file
FILE_N0 := power_a57_nvidia.dat

# Define variables to hold path for all .dat files
FILEPATH_N0 := $(shell readlink -f $(FILE_N0))

# Create directory to split and merge data files
dir_nvidia:
	mkdir run_nvidia;\
	cd run_nvidia;\
	cp -r $(FILEPATH_N0) .;\
	cd ..;\
	# Splitting .dat into individual BM+freq logs
	python3 splitter_freq.py $(FILE_N0) run_nvidia;\
	# Merging all BM+freq into one global merged log
	python3 $(MERGER_SCRIPT) run_nvidia nvidia;\
	# Copy file onto a separate folder to combine with TEST BM merged log
	cp -r run_nvidia/power_measurement_merged_global.txt power_measurement_merged_global_n0.txt

# Command to delete directory created during previous run
clean_run_nvidia:
	rm -rf run_nvidia

# Create separate directory to merge test and train BM logs
create_run_dir:
	mkdir run;\
	mv power_measurement_merged_global_n0.txt run/power_measurement_merged_global_n0.txt;\
	mv power_measurement_merged_global_r0.txt run/power_measurement_merged_global_r0.txt;\
	echo "\n\t Merging Power Logs... \n";\
	cd run;\
	cp -r power_measurement_merged_global_r0.txt power_measurement_merged_global.txt;\
	cat power_measurement_merged_global_n0.txt >> power_measurement_merged_global.txt;\
	echo "\n\t Merging Power Logs...DONE \n";\

clean_run_dir:
	rm -rf run

